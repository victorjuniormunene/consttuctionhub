{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Professional Notification Banner -->
<div style="background: linear-gradient(90deg, #ffeb3b, #ffc107, #ffeb3b); color: #000; padding: 12px 16px; font-weight: 600; font-size: 14px; border: 2px solid #f57c00; border-radius: 10px; margin-bottom: 1.5rem; text-align: center; box-shadow: 0 4px 12px rgba(245, 124, 0, 0.2);">
  üì¢ All notifications are only sent to email | Track your consultations in real-time | Manage your clients
</div>

<style>
/* Base Styles */
.consultant-dashboard { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); min-height: 100vh; padding: 2rem 0; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }

/* Hero Section */
.hero-section { color: white; padding: 3rem 2rem; border-radius: 20px; margin-bottom: 2.5rem; text-align: center; box-shadow: 0 12px 40px rgba(102, 126, 234, 0.35); position: relative; overflow: hidden; background: #667eea; }
.hero-section::before { content: ''; position: absolute; top: -50%; right: -20%; width: 400px; height: 400px; background: rgba(255,255,255,0.1); border-radius: 50%; }
.hero-section::after { content: ''; position: absolute; bottom: -30%; left: -10%; width: 300px; height: 300px; background: rgba(255,255,255,0.05); border-radius: 50%; }
.hero-content { position: relative; z-index: 1; }
.hero-title { font-size: 2.5rem; margin: 0 0 0.75rem 0; font-weight: 800; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.hero-subtitle { font-size: 1.15rem; margin: 0 0 2rem 0; opacity: 0.95; max-width: 600px; margin-left: auto; margin-right: auto; }

/* Stats Cards */
.stat-card { background: white; border: none; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden; }
.stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #ff7f31, #ff4500); }
.stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.15); }
.stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
.stat-number { font-size: 2rem; font-weight: 800; }
.stat-label { color: #666; font-size: 0.95rem; margin: 0; font-weight: 600; }
.stat-description { color: #999; font-size: 0.85rem; margin: 0.25rem 0 0 0; }

/* Section Cards */
.dashboard-section { animation: fadeInUp 0.6s ease-out; }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
.section-card { background: white; border: none; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); transition: transform 0.3s ease, box-shadow 0.3s ease; }
.section-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12); }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0; flex-wrap: wrap; gap: 1rem; }
.section-title { font-size: 1.5rem; font-weight: 700; color: #1a1a2e; margin: 0; display: flex; align-items: center; gap: 0.5rem; }
.section-description { color: #666; margin-bottom: 1.5rem; font-size: 1rem; }

/* Buttons */
.btn-primary { background: linear-gradient(135deg, #ff7f31, #ff4500); border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; text-decoration: none; display: inline-block; transition: all 0.3s ease; }
.btn-primary:hover { background: linear-gradient(135deg, #e66a29, #e03e00); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 127, 49, 0.4); color: white; text-decoration: none; }
.btn-secondary { background: white; color: #ff7f31; padding: 0.75rem 1.5rem; border: 2px solid #ff7f31; border-radius: 10px; font-weight: 600; text-decoration: none; display: inline-block; transition: all 0.3s ease; }
.btn-secondary:hover { background: #ff7f31; color: white; text-decoration: none; }
.btn-success { background: linear-gradient(135deg, #28a745, #20c997); border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; text-decoration: none; display: inline-block; transition: all 0.3s ease; }
.btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4); color: white; text-decoration: none; }
.btn-small { flex: 1; min-width: 80px; padding: 0.5rem; font-size: 0.85rem; border-radius: 8px; text-align: center; font-weight: 600; text-decoration: none; display: inline-block; transition: all 0.2s ease; }

/* Status Badges */
.status-badge { display: inline-block; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.status-completed { background: #d4edda; color: #155724; }
.status-pending { background: #fff3cd; color: #856404; }
.status-scheduled { background: #cce5ff; color: #004085; }
.status-canceled { background: #f8d7da; color: #721c24; }
.status-default { background: #e2e3e5; color: #383d41; }

/* Empty State */
.empty-state { text-align: center; padding: 3rem 2rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 16px; border: 2px dashed #dee2e6; }
.empty-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
.empty-title { font-size: 1.3rem; font-weight: 600; color: #495057; margin-bottom: 0.5rem; }
.empty-description { color: #6c757d; margin-bottom: 1.5rem; font-size: 1rem; }

/* Table Styles */
.table-container { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
.table-header { display: grid; grid-template-columns: 1.5fr 1.5fr 2fr 1fr 1fr 1fr; gap: 1rem; padding: 1rem 1.5rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef); font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6; }
.table-row { display: grid; grid-template-columns: 1.5fr 1.5fr 2fr 1fr 1fr 1fr; gap: 1rem; padding: 1rem 1.5rem; border-bottom: 1px solid #e9ecef; align-items: center; transition: background 0.2s ease; }
.table-row:hover { background: #f8f9fa; }

/* Cards Grid */
.consultation-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
.consultation-card { background: white; border: none; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: all 0.3s ease; overflow: hidden; }
.consultation-card:hover { transform: translateY(-6px); box-shadow: 0 16px 40px rgba(0,0,0,0.15); }
.consultation-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
.consultation-customer { font-size: 1.1rem; font-weight: 700; color: #1a1a2e; margin-bottom: 0.25rem; }
.consultation-email { color: #6c757d; font-size: 0.85rem; margin: 0; }
.consultation-details { background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; }
.consultation-detail-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; }
.consultation-detail-label { font-weight: 600; color: #495057; }
.consultation-detail-value { color: #6c757d; }

/* Customer Cards */
.customer-card { background: white; border: none; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: all 0.3s ease; }
.customer-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.12); }
.customer-name { font-size: 1.15rem; font-weight: 700; color: #1a1a2e; margin-bottom: 0.5rem; }
.customer-info { color: #6c757d; font-size: 0.9rem; line-height: 1.6; }
.customer-role { background-color: #e0e0e0; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85rem; }
.action-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }

/* Responsive */
@media (max-width: 768px) {
  .hero-title { font-size: 1.8rem; }
  .table-header, .table-row { grid-template-columns: 1fr; gap: 0.5rem; }
  .table-header { display: none; }
  .table-row { padding: 1rem; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 0.5rem; }
}
</style>

<div class="consultant-dashboard">
  <div class="container">
    
    <!-- Hero Section -->
    <section class="hero-section dashboard-section">
      <div class="hero-content">
        <h1 class="hero-title">üëã Welcome back, {{ request.user.get_full_name|default:request.user.username }}!</h1>
        <p class="hero-subtitle">Manage your consultations, customer details, and pending orders with ease.</p>
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
          <a href="{% url 'accounts:consultant_application' %}" style="background: rgba(255, 255, 255, 0.25); color: white; padding: 1rem 2rem; border-radius: 12px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3);" onmouseover="this.style.background='rgba(255,255,255,0.35)'; this.style.transform='translateY(-3px)';" onmouseout="this.style.background='rgba(255,255,255,0.25)'; this.style.transform='translateY(0)';">
            üìù Update Profile
          </a>
          <a href="{% url 'dashboard:download_consultant_report' %}" style="background: rgba(255, 255, 255, 0.25); color: white; padding: 1rem 2rem; border-radius: 12px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3);" onmouseover="this.style.background='rgba(255,255,255,0.35)'; this.style.transform='translateY(-3px)';" onmouseout="this.style.background='rgba(255,255,255,0.25)'; this.style.transform='translateY(0)';">
            üìä Download Report
          </a>
        </div>
      </div>
    </section>

    <!-- Quick Stats Section -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem;">
      {% if consultant_app %}
      <div class="stat-card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
          <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">üë§</div>
          <span class="stat-number" style="color: #667eea;">{{ consultant_app.full_name|truncatechars:15 }}</span>
        </div>
        <h3 class="stat-label">Your Name</h3>
        <p class="stat-description">{{ consultant_app.specialization|default:"Professional Consultant" }}</p>
      </div>
      <div class="stat-card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
          <div class="stat-icon" style="background: linear-gradient(135deg, #17a2b8, #20c997);">üìû</div>
          <span class="stat-number" style="color: #17a2b8;">{{ consultant_app.phone|default:"N/A" }}</span>
        </div>
        <h3 class="stat-label">Contact Number</h3>
        <p class="stat-description">Phone available</p>
      </div>
      <div class="stat-card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
          <div class="stat-icon" style="background: linear-gradient(135deg, #28a745, #20c997);">üí∞</div>
          <span class="stat-number" style="color: #28a745;">KSH {{ consultant_app.consultation_rate }}</span>
        </div>
        <h3 class="stat-label">Rate</h3>
        <p class="stat-description">Per Hour/Session</p>
      </div>
      {% endif %}
      <div class="stat-card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
          <div class="stat-icon" style="background: linear-gradient(135deg, #ff7f31, #ff4500);">üìã</div>
          <span class="stat-number" style="color: #ff7f31;">{{ total_assigned }}</span>
        </div>
        <h3 class="stat-label">Total Consultations</h3>
        <p class="stat-description">All time</p>
      </div>
      <div class="stat-card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
          <div class="stat-icon" style="background: linear-gradient(135deg, #ffc107, #fd7e14);">‚è≥</div>
          <span class="stat-number" style="color: #ffc107;">{{ pending_count }}</span>
        </div>
        <h3 class="stat-label">Pending</h3>
        <p class="stat-description">Awaiting action</p>
      </div>
      <div class="stat-card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
          <div class="stat-icon" style="background: linear-gradient(135deg, #28a745, #20c997);">‚úÖ</div>
          <span class="stat-number" style="color: #28a745;">{{ completed_count }}</span>
        </div>
        <h3 class="stat-label">Completed</h3>
        <p class="stat-description">Successfully done</p>
      </div>
    </div>

    <!-- Pending Issues Section -->
    <section class="section-card dashboard-section" style="animation-delay: 0.1s;">
      <div class="section-header">
        <h2 class="section-title">üö® Pending Consultations</h2>
      </div>
      <p class="section-description">Consultations awaiting your attention</p>
      
      {% if pending_consultations %}
        <div class="table-container">
          <div class="table-header">
            <div>Type</div>
            <div>Customer</div>
            <div>Details</div>
            <div>Date</div>
            <div>Status</div>
            <div>Action</div>
          </div>
          {% for consultation in pending_consultations %}
            <div class="table-row">
              <div><span style="background-color: #e3f2fd; color: #1976d2; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: bold;">Consultation</span></div>
              <div><strong>{{ consultation.customer.username }}</strong><div style="color: #6c757d; font-size: 0.85rem;">{{ consultation.customer.email }}</div></div>
              <div><div style="color: #1a1a2e; font-size: 0.9rem;">{{ consultation.details|truncatewords:15 }}</div>{% if consultation.supplier %}<div style="color: #6c757d; font-size: 0.85rem;">Project: {{ consultation.supplier.company_name }}</div>{% endif %}</div>
              <div style="color: #6c757d; font-size: 0.9rem;">{{ consultation.date_requested|date:'M d, Y' }}</div>
              <div><span class="status-badge {% if consultation.status == 'pending' %}status-pending{% elif consultation.status == 'completed' %}status-completed{% elif consultation.status == 'scheduled' %}status-scheduled{% else %}status-default{% endif %}">{{ consultation.status|upper }}</span></div>
              <div>{% if consultation.status == 'pending' or consultation.status == 'pending_payment' or consultation.status == 'scheduled' %}<button class="btn-success btn-small mark-done-btn" data-consultation-id="{{ consultation.id }}">‚úì Mark Done</button>{% elif consultation.status == 'completed' %}<span style="color: #155724; font-weight: 600; font-size: 0.85rem;">‚úÖ Done</span>{% else %}<span style="color: #004085; font-weight: 600; font-size: 0.85rem;">{{ consultation.status }}</span>{% endif %}</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">‚ú®</div>
          <h3 class="empty-title">All caught up!</h3>
          <p class="empty-description">No pending consultations at the moment.</p>
        </div>
      {% endif %}
    </section>

    <!-- Consultation Bookings Section -->
    <section class="section-card dashboard-section" style="animation-delay: 0.15s;">
      <div class="section-header">
        <h2 class="section-title">üìö Your Consultation Bookings</h2>
      </div>
      <p class="section-description">All your scheduled and completed consultations</p>
      
      {% if assigned_consultations %}
        <div class="consultation-grid">
          {% for consultation in assigned_consultations %}
            <div class="consultation-card">
              <div class="consultation-header">
                <div>
                  <h3 class="consultation-customer">üë§ {{ consultation.customer.first_name|default:consultation.customer.username }}</h3>
                  <p class="consultation-email">{{ consultation.customer.email }}</p>
                  {% if consultation.customer.phone %}<p class="consultation-email">üìû {{ consultation.customer.phone }}</p>{% endif %}
                </div>
                <span class="status-badge {% if consultation.status == 'completed' %}status-completed{% elif consultation.status == 'scheduled' %}status-scheduled{% elif consultation.status == 'pending' %}status-pending{% else %}status-default{% endif %}">{{ consultation.status|upper }}</span>
              </div>
              <div class="consultation-details">
                <div class="consultation-detail-row"><span class="consultation-detail-label">üìÖ Requested:</span><span class="consultation-detail-value">{{ consultation.date_requested|date:'M d, Y H:i' }}</span></div>
                <div class="consultation-detail-row"><span class="consultation-detail-label">üí∞ Rate:</span><span class="consultation-detail-value">KSH {{ consultation.consultation_rate }}</span></div>
                {% if consultation.specialization %}<div class="consultation-detail-row"><span class="consultation-detail-label">üéì Specialization:</span><span class="consultation-detail-value">{{ consultation.specialization }}</span></div>{% endif %}
                {% if consultation.date_scheduled %}<div class="consultation-detail-row"><span class="consultation-detail-label" style="color: #28a745;">‚úì Scheduled:</span><span class="consultation-detail-value" style="color: #28a745; font-weight: 600;">{{ consultation.date_scheduled|date:'M d, Y H:i' }}</span></div>{% endif %}
              </div>
              {% if consultation.details %}
                <div style="background: white; padding: 0.75rem; border-left: 3px solid #ff7f31; border-radius: 4px; margin-bottom: 1rem;">
                  <p style="margin: 0; color: #6c757d; font-size: 0.85rem; line-height: 1.4;"><strong>Customer Notes:</strong> {{ consultation.details|truncatewords:30 }}</p>
                </div>
              {% endif %}
              <div class="action-buttons">
                {% if consultation.status == 'pending' or consultation.status == 'pending_payment' or consultation.status == 'scheduled' %}<button class="btn-success btn-small mark-done-btn" data-consultation-id="{{ consultation.id }}">‚úì Mark Done</button>{% endif %}
                <button class="btn-secondary btn-small open-email-modal" data-email="{{ consultation.customer.email }}" data-name="{{ consultation.customer.first_name|default:consultation.customer.username }}">‚úâÔ∏è Email</button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">üìö</div>
          <h3 class="empty-title">No consultation bookings yet</h3>
          <p class="empty-description">Customers will book consultations with you once your profile is active.</p>
        </div>
      {% endif %}
    </section>

    <!-- Customers Overview Section -->
    <section class="section-card dashboard-section" style="animation-delay: 0.2s;">
      <div class="section-header">
        <h2 class="section-title">üë• Customer Details & Activity</h2>
      </div>
      <p class="section-description">Overview of your customers and their consultation history</p>
      
      {% if customers %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
          {% for customer in customers %}
            <div class="customer-card">
              <div class="customer-header">
                <div>
                  <h3 class="customer-name">üë§ {{ customer.first_name|default:customer.username }}</h3>
                  <p class="customer-info"><strong>Email:</strong> {{ customer.email }}<br><strong>Username:</strong> {{ customer.username }}<br><strong>Role:</strong> <span class="customer-role">{{ customer.get_role_display }}</span></p>
                </div>
              </div>
              {% with customer_consultations=customer.consultations.all %}
                {% if customer_consultations %}
                  <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #ddd;">
                    <h5 style="color: #1a1a2e; margin: 0 0 0.5rem 0; font-size: 0.95rem;">üìã Active Consultations ({{ customer_consultations|length }})</h5>
                    <div style="display: grid; gap: 0.5rem;">
                      {% for consultation in customer_consultations %}
                        {% if consultation.consultant.id == request.user.id %}
                          <div style="background-color: white; padding: 0.75rem; border-left: 3px solid #1976d2; border-radius: 4px;">
                            <div style="color: #1a1a2e; font-size: 0.9rem; font-weight: 500;">{{ consultation.supplier.company_name|default:consultation.consultant_name }}</div>
                            <div style="color: #6c757d; font-size: 0.85rem;">Status: <strong>{{ consultation.status }}</strong> | Requested: {{ consultation.date_requested|date:'M d' }}</div>
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              {% endwith %}
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn-secondary btn-small open-email-modal" data-email="{{ customer.email }}" data-name="{{ customer.first_name|default:customer.username }}">‚úâÔ∏è Email</button>
                <a href="#" class="btn-primary btn-small">View Profile</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">üë•</div>
          <h3 class="empty-title">No customers yet</h3>
          <p class="empty-description">Customer details will appear here once you have assigned consultations or orders.</p>
        </div>
      {% endif %}
    </section>

    <!-- Recent Consultations Section -->
    <section class="section-card dashboard-section" style="animation-delay: 0.25s;">
      <div class="section-header">
        <h2 class="section-title">üìã Recent Consultations</h2>
      </div>
      <p class="section-description">Your latest consultation activities</p>
      
      {% if assigned_consultations %}
        <div class="table-container">
          <div class="table-header">
            <div>Customer</div>
            <div>Project</div>
            <div>Details</div>
            <div>Status</div>
            <div>Date</div>
            <div>Actions</div>
          </div>
          {% for consultation in assigned_consultations|slice:":10" %}
            <div class="table-row">
              <div><strong>{{ consultation.customer.username }}</strong><div style="color: #6c757d; font-size: 0.85rem;">{{ consultation.customer.email }}</div></div>
              <div>{% if consultation.supplier %}{{ consultation.supplier.company_name }}{% else %}N/A{% endif %}</div>
              <div>{{ consultation.details|truncatewords:15 }}</div>
              <div><span class="status-badge {% if consultation.status == 'pending' %}status-pending{% elif consultation.status == 'completed' %}status-completed{% elif consultation.status == 'scheduled' %}status-scheduled{% else %}status-default{% endif %}">{{ consultation.status|upper }}</span></div>
              <div style="font-size: 0.85rem; color: #6c757d;">{{ consultation.date_requested|date:'M d, Y' }}</div>
              <div>{% if consultation.status == 'pending' or consultation.status == 'pending_payment' or consultation.status == 'scheduled' %}<button class="btn-success btn-small mark-done-btn" data-consultation-id="{{ consultation.id }}">‚úì Done</button>{% endif %}</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">üìã</div>
          <h3 class="empty-title">No consultations yet</h3>
          <p class="empty-description">Consultations will appear here once clients request your services.</p>
          <a href="{% url 'accounts:consultant_application' %}" class="btn-primary">Update Profile</a>
        </div>
      {% endif %}
    </section>

    <!-- Print Reports Section -->
    <section class="section-card dashboard-section" style="animation-delay: 0.3s;">
      <div class="section-header">
        <h2 class="section-title">üìÑ Print Reports</h2>
      </div>
      <p class="section-description">Download comprehensive reports of your consultation bookings for your records.</p>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{% url 'dashboard:download_consultant_report' %}" class="btn-success" style="display: inline-flex; align-items: center; gap: 0.5rem;">üìä Download Bookings Report</a>
      </div>
      <small style="color: #999; margin-top: 0.5rem; display: block;">Reports include current date, key points, and all customer booking details</small>
    </section>

    <!-- Quick Actions -->
    <section class="section-card dashboard-section" style="animation-delay: 0.35s;">
      <div class="section-header">
        <h2 class="section-title">‚ö° Quick Actions</h2>
      </div>
      <p class="section-description">Common tasks and shortcuts</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
        <div class="stat-card" style="text-align: center;">
          <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2); margin: 0 auto 1rem;">üìù</div>
          <h3 class="stat-label" style="margin-bottom: 0.5rem;">Update Profile</h3>
          <p class="stat-description" style="margin-bottom: 1rem;">Keep your consultant profile current.</p>
          <a href="{% url 'accounts:consultant_application' %}" class="btn-primary">Edit Profile</a>
        </div>
        <div class="stat-card" style="text-align: center;">
          <div class="stat-icon" style="background: linear-gradient(135deg, #ff7f31, #ff4500); margin: 0 auto 1rem;">üíº</div>
          <h3 class="stat-label" style="margin-bottom: 0.5rem;">My Dashboard</h3>
          <p class="stat-description" style="margin-bottom: 1rem;">View and manage all activities.</p>
          <a href="{% url 'accounts:dashboard' %}" class="btn-primary">View Dashboard</a>
        </div>
        <div class="stat-card" style="text-align: center;">
          <div class="stat-icon" style="background: linear-gradient(135deg, #17a2b8, #20c997); margin: 0 auto 1rem;">üìû</div>
          <h3 class="stat-label" style="margin-bottom: 0.5rem;">Support</h3>
          <p class="stat-description" style="margin-bottom: 1rem;">Get help from our support team.</p>
          <a href="{% url 'accounts:contact' %}" class="btn-secondary">Contact Support</a>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- Email Modal -->
<div id="emailModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
  <div class="modal-content" style="background-color: #fefefe; margin: 10% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
    <div style="background: linear-gradient(135deg, #ff7f31, #ff4500); padding: 1.5rem; border-radius: 12px 12px 0 0; color: white;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 1.5rem;">‚úâÔ∏è Send Email to Client</h2>
        <span class="close-modal" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>
      <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Send a message to your client via email</p>
    </div>
    <div style="padding: 1.5rem;">
      <form id="emailForm">
        {% csrf_token %}
        <input type="hidden" id="recipientEmail" name="recipient_email">
        
        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1a1a2e;">To:</label>
          <input type="email" id="recipientEmailDisplay" readonly style="width: 100%; padding: 0.75rem; border: 2px solid #dee2e6; border-radius: 8px; background-color: #f8f9fa; color: #495057; font-size: 1rem;">
        </div>
        
        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1a1a2e;">Client Name:</label>
          <input type="text" id="clientName" readonly style="width: 100%; padding: 0.75rem; border: 2px solid #dee2e6; border-radius: 8px; background-color: #f8f9fa; color: #495057; font-size: 1rem;">
        </div>
        
        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1a1a2e;">Subject: <span style="color: red;">*</span></label>
          <input type="text" id="emailSubject" required placeholder="Enter email subject" style="width: 100%; padding: 0.75rem; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s;">
        </div>
        
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1a1a2e;">Message: <span style="color: red;">*</span></label>
          <textarea id="emailMessage" required rows="5" placeholder="Type your message to the client..." style="width: 100%; padding: 0.75rem; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1rem; resize: vertical; transition: border-color 0.3s;"></textarea>
        </div>
        
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
          <button type="button" class="cancel-email-btn" style="padding: 0.75rem 1.5rem; border: 2px solid #dee2e6; background: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">Cancel</button>
          <button type="submit" id="sendEmailBtn" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #ff7f31, #ff4500); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">‚úâÔ∏è Send Email</button>
        </div>
      </form>
      
      <div id="emailStatus" style="margin-top: 1rem; display: none;"></div>
    </div>
  </div>
</div>

<style>
.modal {
  animation: fadeIn 0.3s;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.modal-content {
  animation: slideIn 0.3s;
}
@keyframes slideIn {
  from { transform: translateY(-50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
#emailForm input:focus, #emailForm textarea:focus {
  outline: none;
  border-color: #ff7f31 !important;
}
#sendEmailBtn:hover {
  background: linear-gradient(135deg, #e66a29, #e03e00) !important;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 127, 49, 0.4);
}
#sendEmailBtn:disabled {
  background: #ccc !important;
  cursor: not-allowed;
  transform: none;
}
.cancel-email-btn:hover {
  background: #f8f9fa !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Mark Done button functionality
  const markDoneBtns = document.querySelectorAll('.mark-done-btn');
  markDoneBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const consultationId = this.getAttribute('data-consultation-id');
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || getCookie('csrftoken');
      if (!confirm('Mark this consultation as completed?')) { return; }
      fetch(`{% url 'consultations:mark_consultation_completed' 0 %}`.replace('0', consultationId), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) { alert('Consultation marked as completed!'); location.reload(); }
        else { alert('Error: ' + (data.error || 'Failed to update consultation')); }
      })
      .catch(error => { console.error('Error:', error); alert('Error marking consultation as completed'); });
    });
  });
  
  // Email modal functionality
  const modal = document.getElementById('emailModal');
  const emailForm = document.getElementById('emailForm');
  const emailStatus = document.getElementById('emailStatus');
  const sendEmailBtn = document.getElementById('sendEmailBtn');
  
  // Open email modal when button is clicked
  const emailButtons = document.querySelectorAll('.open-email-modal');
  emailButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const email = this.getAttribute('data-email');
      const name = this.getAttribute('data-name') || 'Client';
      
      document.getElementById('recipientEmail').value = email;
      document.getElementById('recipientEmailDisplay').value = email;
      document.getElementById('clientName').value = name;
      document.getElementById('emailSubject').value = '';
      document.getElementById('emailMessage').value = '';
      
      emailStatus.style.display = 'none';
      sendEmailBtn.disabled = false;
      sendEmailBtn.innerHTML = '‚úâÔ∏è Send Email';
      
      modal.style.display = 'block';
    });
  });
  
  // Close modal
  const closeModal = () => {
    modal.style.display = 'none';
  };
  
  document.querySelector('.close-modal').addEventListener('click', closeModal);
  document.querySelector('.cancel-email-btn').addEventListener('click', closeModal);
  
  // Close modal when clicking outside
  window.addEventListener('click', function(event) {
    if (event.target === modal) {
      closeModal();
    }
  });
  
  // Send email form submission
  emailForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const recipientEmail = document.getElementById('recipientEmail').value;
    const subject = document.getElementById('emailSubject').value;
    const message = document.getElementById('emailMessage').value;
    
    if (!recipientEmail || !subject || !message) {
      showStatus('Please fill in all required fields', 'error');
      return;
    }
    
    sendEmailBtn.disabled = true;
    sendEmailBtn.innerHTML = '‚è≥ Sending...';
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
    
    fetch('{% url "dashboard:send_consultant_email" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        recipient_email: recipientEmail,
        subject: subject,
        message: message
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showStatus('‚úÖ Email sent successfully to ' + recipientEmail, 'success');
        sendEmailBtn.innerHTML = '‚úÖ Sent!';
        setTimeout(() => {
          closeModal();
        }, 1500);
      } else {
        showStatus('‚ùå Error: ' + (data.error || 'Failed to send email'), 'error');
        sendEmailBtn.disabled = false;
        sendEmailBtn.innerHTML = '‚úâÔ∏è Send Email';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showStatus('‚ùå Error: Failed to send email. Please try again.', 'error');
      sendEmailBtn.disabled = false;
      sendEmailBtn.innerHTML = '‚úâÔ∏è Send Email';
    });
  });
  
  function showStatus(message, type) {
    emailStatus.innerHTML = message;
    emailStatus.style.display = 'block';
    emailStatus.style.padding = '0.75rem';
    emailStatus.style.borderRadius = '8px';
    emailStatus.style.marginTop = '1rem';
    
    if (type === 'success') {
      emailStatus.style.backgroundColor = '#d4edda';
      emailStatus.style.color = '#155724';
      emailStatus.style.border = '1px solid #c3e6cb';
    } else {
      emailStatus.style.backgroundColor = '#f8d7da';
      emailStatus.style.color = '#721c24';
      emailStatus.style.border = '1px solid #f5c6cb';
    }
  }
});

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

{% endblock %}
